(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/indexApp/sswd/sswd"],{"03f0":function(o,t,e){"use strict";(function(o){function e(o,t){var e=Object.keys(o);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(o);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(o,t).enumerable}))),e.push.apply(e,n)}return e}function n(o){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?e(Object(n),!0).forEach((function(t){r(o,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(n)):e(Object(n)).forEach((function(t){Object.defineProperty(o,t,Object.getOwnPropertyDescriptor(n,t))}))}return o}function r(o,t,e){return t in o?Object.defineProperty(o,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):o[t]=e,o}function i(o,t){if(!(o instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=function o(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"heartbeat",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"Index";i(this,o),this.param=t,this.action=e,this.controller=n},a={data:function(){return{isSocketClose:!1,reconnectCount:5,heartbeatInterval:"",isStart:!1,openid:"",pagetype:"list",roomUsers:[],roomInfo:{},wxUserInfo:{},roomList:[],roomStatusData:{inGame:"游戏中",await:"等待中",gameOver:"结束"},roomStatusDataCorlor:{inGame:"#F56C6C",await:"#67C23A",gameOver:"#909399"},IdentityEmun:{PM:"平民",WD:"卧底",BB:"白板"}}},onShareAppMessage:function(o){return{title:"谁是卧底",path:"/pages/indexApp/sswd/sswd",success:function(o){},fail:function(o){}}},onShow:function(){this.isSocketClose=!1,this.getRoomList()},mounted:function(){var t=this.$currency.getOpenid();t?(this.openid=t,this.pagetype="list",this.init()):(wx.showToast({title:"请先登录",icon:"none"}),o.navigateTo({url:"/pages/indexApp/setting/setting"}))},onUnload:function(){this.isSocketClose=!0,this.tuichu()},methods:{actionUser:function(t){var e=this,n=["投票出局"];o.showActionSheet({itemList:n,success:function(o){0==o.tapIndex&&e.$http({url:"/Throw/out",method:"post",data:{roomNum:e.roomInfo.roomNum,userId:t.id}}).then((function(o){o.success||wx.showToast({title:"投票出局失败!",icon:"error"})}))},fail:function(o){console.log(o.errMsg)}})},startGame:function(){this.roomUsers.length<4||this.roomUsers.length>9?o.showModal({title:"提示",content:"房间人数太多或房间人数太少",showCancel:!1,success:function(o){o.confirm}}):this.$http({url:"/room/start/"+this.roomInfo.roomNum,method:"get"}).then((function(o){o.success||wx.showToast({title:"开始失败!",icon:"error"})}))},getRoomList:function(){var o=this;this.$http({url:"/room/list",method:"get"}).then((function(t){console.log("房间列表:",t),t.success?o.roomList=t.data:wx.showToast({title:"房间列表获取失败!",icon:"none"})}))},intoRoom:function(t){var e=this;o.showLoading({title:"进入房间中..."});var r=wx.getStorageSync("wxUserInfo");this.$http({url:"/into/room",method:"post",data:n(n({},r),{},{id:this.openid,roomNum:t.roomNum})}).then((function(t){o.hideLoading(),console.log("进入房间:",t),t.success?(e.pagetype="room",e.roomInfo=t.data.roomInfo,e.roomInfo.roomNum=t.data.roomNum,e.roomUsers=t.data.roomInfo.users):wx.showToast({title:"进入房间失败!",icon:"error"})}))},getRoomInfo:function(o){var t=this;this.$http({url:"/room/info/"+o,method:"get"}).then((function(o){console.log("房间信息:",o),o.success?(t.pagetype="room",t.roomInfo=o.data.roomInfo,t.roomInfo.roomNum=o.data.roomNum,t.roomUsers=o.data.roomInfo.users):wx.showToast({title:"房间列表获取失败!",icon:"none"})}))},chuangjian:function(){var t=this;o.showLoading({title:"创建房间中..."});var e=wx.getStorageSync("wxUserInfo");this.wxUserInfo=e,this.$http({url:"/found/home",method:"post",data:n(n({},e),{},{id:this.openid})}).then((function(e){o.hideLoading(),console.log("/found/home:",e),e.success?(t.pagetype="room",t.roomInfo=e.data.roomInfo,t.roomInfo.roomNum=e.data.roomNum,t.roomUsers=e.data.roomInfo.users):wx.showToast({title:"创建房间失败!",icon:"error"})}))},tuichu:function(){var t=this;o.showLoading({title:"退出房间中..."}),this.pagetype="list",this.$http({url:"/out/room",method:"post",data:{id:this.openid,roomNum:this.roomInfo.roomNum}}).then((function(e){o.hideLoading(),e.success?(t.roomList=e.data,t.outRoomClearnData()):wx.showToast({title:"房间列表获取失败!",icon:"none"})}))},GameEnd:function(){this.$http({url:"/room/end/"+this.roomInfo.roomNum,method:"get",data:{id:this.openid,roomNum:this.roomInfo.roomNum}}).then((function(t){o.hideLoading(),console.log("结束游戏:",t),t.success||wx.showToast({title:"结束游戏失败!",icon:"none"})}))},init:function(){var t=this,e=this,n=this.$url.socketUrl;o.connectSocket({url:n+"/"+this.openid,fail:function(t){o.showToast(JSON.stringify(t))}}),o.onSocketOpen((function(o){console.log("WebSocket打开"),e.reconnectCount=5,clearInterval(e.heartbeatInterval),e.heartbeatInterval=null,e.heartbeatInterval=setInterval((function(){e.sendMsg(new s({name:"PING",id:e.openid}))}),5e3)})),o.onSocketError((function(o){console.log("WebSocket连接打开失败，请检查！"),e.isSocketClose||r(n)})),o.onSocketMessage((function(t){var n=JSON.parse(t.data);console.log("Message:",n),"RefreshRoomInfo"==n.type?e.handleRoomData(n):"RefreshList"==n.type?e.roomList=n.data:"userBeOut"==n.type?(wx.showToast({title:n.data.userData.nickName+"被投票出局!",icon:"none"}),e.handleRoomData(n)):"goInGame"==n.type?(o.hideLoading(),e.intoRoom({roomNum:n.roomNum})):"sswd"==n.type&&(o.hideLoading(),console.log("连接成功"),e.outRoomClearnData(!0))})),o.onSocketClose((function(o){console.log("WebSocket 已关闭！"),e.isSocketClose||r(n)}));var r=function(){o.showLoading({title:"断线重连中"});var e=setTimeout((function(){var r="第".concat(5-t.reconnectCount+1,"次断线重连中...");o.showLoading({title:r}),console.log(r),t.reconnectCount--,t.reconnectCount<=0?(t.$toast("error"),o.navigateTo({url:"pages/indexApp/xkt/xkt"})):o.connectSocket({url:n+"/"+t.openid}),clearTimeout(e),e=null}),3e3)}},handleRoomData:function(o){var t=this;t.roomInfo.roomNum&&"room"==t.pagetype&&(t.pagetype="room",t.roomInfo=o.data.roomInfo,t.roomInfo.roomNum=o.data.roomNum,t.roomUsers=o.data.roomInfo.users)},outRoomClearnData:function(o){this.pagetype="list",this.roomUsers=[],this.roomInfo={},o&&this.getRoomList()},sendMsg:function(t){t=JSON.stringify(t);try{o.sendSocketMessage({data:t,success:function(o){},fail:function(o){console.log("senderr",o)}})}catch(e){this.isSocketClose=!0,o.closeSocket()}},listBack:function(){o.reLaunch({url:"/pages/index/index"})},roomBack:function(){var t=this;"inGame"==this.roomInfo.roomStatus?o.showModal({title:"提示",content:"正在游戏中，确定要退出游戏？",success:function(o){o.confirm?t.tuichu():o.cancel}}):["gameOver","await"].includes(this.roomInfo.roomStatus)&&this.tuichu()}}};t.default=a}).call(this,e("543d")["default"])},"26ef":function(o,t,e){"use strict";e.d(t,"b",(function(){return r})),e.d(t,"c",(function(){return i})),e.d(t,"a",(function(){return n}));var n={uNavbar:function(){return e.e("node-modules/uview-ui/components/u-navbar/u-navbar").then(e.bind(null,"8f56"))},uIcon:function(){return e.e("node-modules/uview-ui/components/u-icon/u-icon").then(e.bind(null,"7ede"))},uButton:function(){return e.e("node-modules/uview-ui/components/u-button/u-button").then(e.bind(null,"1ffd"))}},r=function(){var o=this,t=o.$createElement,e=(o._self._c,"list"!=o.pagetype&&"room"==o.pagetype&&o.roomInfo.Homeowner.id==o.openid?["gameOver","await"].includes(o.roomInfo.roomStatus):null);o.$mp.data=Object.assign({},{$root:{g0:e}})},i=[]},"35f8":function(o,t,e){},"3d2b":function(o,t,e){"use strict";e.r(t);var n=e("26ef"),r=e("5b80");for(var i in r)"default"!==i&&function(o){e.d(t,o,(function(){return r[o]}))}(i);e("65da");var s,a=e("f0c5"),c=Object(a["a"])(r["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],s);t["default"]=c.exports},"5b80":function(o,t,e){"use strict";e.r(t);var n=e("03f0"),r=e.n(n);for(var i in n)"default"!==i&&function(o){e.d(t,o,(function(){return n[o]}))}(i);t["default"]=r.a},"65da":function(o,t,e){"use strict";var n=e("35f8"),r=e.n(n);r.a},d385:function(o,t,e){"use strict";(function(o){e("0469");n(e("66fd"));var t=n(e("3d2b"));function n(o){return o&&o.__esModule?o:{default:o}}wx.__webpack_require_UNI_MP_PLUGIN__=e,o(t.default)}).call(this,e("543d")["createPage"])}},[["d385","common/runtime","common/vendor"]]]);